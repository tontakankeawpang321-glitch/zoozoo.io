<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ & ‡∏ï‡∏•‡∏≤‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πâ üöú</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Kanit', 'sans-serif'],
                    },
                    colors: {
                        leaf: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                        },
                        market: {
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                        },
                        veg: {
                            500: '#84cc16', // lime-500
                            600: '#65a30d', // lime-600
                        },
                        bot: {
                            500: '#8b5cf6',
                            600: '#7c3aed',
                        }
                    },
                    animation: {
                        'pop': 'pop 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            overscroll-behavior-y: none; 
        }
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Custom Table Style */
        .market-table th {
            font-weight: 600;
            font-size: 0.85rem;
            color: #475569;
            padding: 12px 8px;
            background-color: #f1f5f9;
        }
        .market-table td {
            font-size: 0.85rem;
            padding: 12px 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        .trend-up { color: #22c55e; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #94a3b8; }
        
        .tab-active {
            background-color: white;
            color: #15803d;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-inactive {
            color: #4b5563;
        }
        
        /* Market specific tabs */
        .market-tab-active {
            background-color: #0ea5e9;
            color: white;
        }
        .market-tab-inactive {
            background-color: #e0f2fe;
            color: #0284c7;
        }

        /* Modal Tabs */
        .modal-tab-active {
            border-bottom: 2px solid #16a34a;
            color: #16a34a;
            font-weight: 600;
        }
        .modal-tab-inactive {
            border-bottom: 2px solid transparent;
            color: #64748b;
        }

        /* Chat Styles */
        .chat-msg {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .chat-user {
            background-color: #7c3aed;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bot {
            background-color: #f3f4f6;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        .typing-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #9ca3af;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="text-gray-700 pb-28 relative min-h-screen">

    <!-- Navbar (Sticky Top) -->
    <nav class="bg-leaf-700 text-white p-3 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i class="fa-solid fa-seedling text-yellow-300"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÑ‡∏ó‡∏¢
            </h1>
            <div class="flex gap-2">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç -->
                <button onclick="openCalculator()" class="bg-white/20 active:bg-white/30 px-3 py-1.5 rounded-lg text-sm transition flex items-center gap-1 hover:bg-white/30">
                    <i class="fa-solid fa-calculator"></i> <span class="hidden sm:inline">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç</span>
                </button>
                 <button onclick="toggleView('schedule')" class="bg-white/20 active:bg-white/30 px-3 py-1.5 rounded-lg text-sm transition flex items-center gap-1">
                    <i class="fa-solid fa-clipboard-list"></i> ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (<span id="schedule-count">0</span>)
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-3 py-4 max-w-lg">
        
        <!-- View: Calendar Selection -->
        <div id="calendar-view">
            <!-- Header: Date & Season (Interactive) -->
            <div class="bg-gradient-to-r from-leaf-600 to-leaf-500 rounded-2xl p-5 shadow-lg mb-4 text-white relative overflow-hidden transition-all duration-500" id="season-header-bg">
                <i class="fa-solid fa-cloud-sun text-6xl absolute -right-2 -top-2 opacity-20" id="season-icon-bg"></i>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fa-regular fa-calendar text-white/80"></i>
                        <input type="date" id="global-date-picker" class="bg-white/20 border-0 rounded px-2 py-0.5 text-sm text-white placeholder-white focus:outline-none focus:ring-2 focus:ring-white/50 cursor-pointer">
                    </div>
                    
                    <h2 class="text-3xl font-bold mt-2 flex items-center gap-3">
                        <span id="current-season-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</span>
                        <i class="fa-solid fa-cloud text-2xl opacity-80" id="season-icon-small"></i>
                    </h2>
                    
                    <p class="text-xs mt-2 bg-white/20 inline-block px-2 py-1 rounded-lg backdrop-blur-sm">
                        <i class="fa-solid fa-location-dot"></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </p>
                </div>
            </div>

            <!-- Tab Switcher (Main View) -->
            <div class="bg-gray-100 p-1 rounded-xl flex mb-4 relative z-10">
                <button onclick="switchCategory('fruit')" id="tab-fruit" class="flex-1 py-2 text-sm font-bold rounded-lg transition-all duration-200 flex items-center justify-center gap-2 tab-active">
                    <i class="fa-solid fa-apple-whole"></i> ‡∏ú‡∏•‡πÑ‡∏°‡πâ
                </button>
                <button onclick="switchCategory('veg')" id="tab-veg" class="flex-1 py-2 text-sm font-bold rounded-lg transition-all duration-200 flex items-center justify-center gap-2 tab-inactive">
                    <i class="fa-solid fa-carrot"></i> ‡∏ú‡∏±‡∏Å‡∏™‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß
                </button>
            </div>

            <!-- Search & Filter -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-4 border border-gray-100 sticky top-[60px] z-40">
                <div class="flex gap-2 mb-3">
                    <div class="relative flex-grow">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏∑‡∏ä..." class="w-full pl-9 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-leaf-500 text-sm">
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <p class="text-xs text-gray-500">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: <span id="filter-status" class="font-bold text-gray-700">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></p>
                    <button onclick="filterCurrentMonth()" class="bg-orange-100 text-orange-600 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm hover:bg-orange-200 transition flex items-center gap-1 animate-pulse-slow">
                        <i class="fa-solid fa-star"></i> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                    </button>
                </div>
            </div>

            <!-- List of Crops -->
            <div class="grid grid-cols-1 gap-3" id="fruit-list">
                <!-- Items will be injected here -->
            </div>
        </div>

        <!-- View: My Schedule (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô) -->
        <div id="schedule-view" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô üå±</h2>
                <button onclick="toggleView('calendar')" class="text-leaf-600 bg-leaf-50 px-3 py-1 rounded-lg text-sm">
                    <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
            </div>

            <div id="schedule-list" class="space-y-3">
                <!-- Schedule Items injected here -->
            </div>
            
            <div id="empty-schedule" class="hidden flex flex-col items-center justify-center py-10 text-gray-400">
                <i class="fa-solid fa-clipboard text-5xl mb-3 opacity-30"></i>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</p>
                <button onclick="toggleView('calendar')" class="mt-4 text-leaf-600 underline text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏•‡∏¢</button>
            </div>
        </div>

    </div>

    <!-- Floating Chatbot Button -->
    <button onclick="toggleChat()" class="fixed z-50 bottom-24 right-4 md:bottom-8 md:right-8 bg-bot-600 hover:bg-bot-500 text-white p-4 rounded-full shadow-xl transition-all duration-300 transform hover:scale-110 active:scale-95 flex items-center justify-center w-14 h-14 border-4 border-white">
        <i class="fa-solid fa-robot text-2xl animate-bounce-slow"></i>
    </button>

    <!-- Chatbot Window -->
    <div id="chatbot-window" class="fixed z-[60] bottom-0 right-0 w-full sm:w-[350px] sm:bottom-24 sm:right-4 h-[80vh] sm:h-[500px] bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col transform translate-y-full transition-transform duration-300 border border-gray-200 hidden">
        
        <!-- Chat Header -->
        <div class="bg-bot-600 text-white p-4 rounded-t-2xl flex justify-between items-center shadow-md">
            <div class="flex items-center gap-2">
                <div class="bg-white/20 p-2 rounded-full">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div>
                    <h3 class="font-bold text-sm">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Å‡∏©‡∏ï‡∏£ AI</h3>
                    <p class="text-[10px] text-white/80 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="text-white/80 hover:text-white transition">
                <i class="fa-solid fa-chevron-down sm:fa-xmark text-lg"></i>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto bg-gray-50 flex flex-col gap-2 custom-scrollbar">
            <div class="chat-msg chat-bot">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! üåæ ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-3 bg-white border-t border-gray-100 flex items-center gap-2">
            <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..." class="flex-grow bg-gray-100 border-0 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-bot-500 focus:outline-none" onkeypress="handleChatEnter(event)">
            <button onclick="sendChatMessage()" class="bg-bot-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-sm hover:bg-bot-500 transition active:scale-95">
                <i class="fa-solid fa-paper-plane text-sm"></i>
            </button>
        </div>
    </div>

    <!-- Modal: Planting Calculator & Guide (Dialog) -->
    <div id="calc-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:w-[450px] sm:rounded-2xl rounded-t-2xl shadow-2xl animate-slide-up flex flex-col max-h-[90vh]">
            
            <!-- Modal Header -->
            <div class="p-4 bg-leaf-50 border-b border-gray-100 rounded-t-2xl flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span id="modal-icon" class="text-3xl">ü•≠</span>
                    <div>
                        <h3 class="font-bold text-lg text-gray-800" id="modal-title">‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á</h3>
                        <p class="text-xs text-gray-500" id="modal-desc">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß ~90 ‡∏ß‡∏±‡∏ô</p>
                    </div>
                </div>
                <button onclick="closeCalcModal()" class="w-8 h-8 rounded-full bg-white text-gray-500 shadow-sm flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <!-- Modal Tabs -->
            <div class="flex border-b border-gray-100" id="modal-tabs">
                <button onclick="switchModalTab('timeline')" id="mtab-timeline" class="flex-1 py-3 text-sm font-medium modal-tab-active transition-colors">
                    <i class="fa-solid fa-calendar-days mr-1"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô
                </button>
                <button onclick="switchModalTab('guide')" id="mtab-guide" class="flex-1 py-3 text-sm font-medium modal-tab-inactive transition-colors">
                    <i class="fa-solid fa-book-open mr-1"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏π‡πÅ‡∏•
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-5 overflow-y-auto bg-white flex-grow">
                
                <!-- Content: Timeline -->
                <div id="modal-content-timeline">
                    <!-- Input Date -->
                    <div class="mb-6" id="date-input-container">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏î‡∏¥‡∏ô)</label>
                        <input type="date" id="start-date" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-leaf-500 focus:border-leaf-500 outline-none text-lg text-center bg-gray-50 text-gray-800">
                    </div>

                    <!-- Timeline Preview -->
                    <div class="relative pl-4 border-l-2 border-gray-200 space-y-6">
                        <!-- Start -->
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 bg-green-500 w-3 h-3 rounded-full border-2 border-white shadow"></div>
                            <p class="text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å</p>
                            <p class="font-bold text-gray-800 text-lg" id="preview-start-date">-</p>
                        </div>
                        
                        <!-- Fertilize -->
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 bg-yellow-400 w-3 h-3 rounded-full border-2 border-white shadow"></div>
                            <p class="text-xs text-gray-500">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ (+<span id="days-fertilize"></span> ‡∏ß‡∏±‡∏ô)</p>
                            <p class="font-bold text-yellow-700 text-lg" id="preview-fertilize-date">-</p>
                        </div>

                        <!-- Harvest -->
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 bg-orange-500 w-3 h-3 rounded-full border-2 border-white shadow"></div>
                            <p class="text-xs text-gray-500">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (+<span id="days-harvest"></span> ‡∏ß‡∏±‡∏ô)</p>
                            <p class="font-bold text-orange-700 text-lg" id="preview-harvest-date">-</p>
                        </div>
                    </div>
                </div>

                <!-- Content: Guide (New) -->
                <div id="modal-content-guide" class="hidden space-y-4">
                    
                    <!-- Planting -->
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <h4 class="font-bold text-green-800 mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-trowel text-green-600"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏•‡∏π‡∏Å
                        </h4>
                        <p class="text-sm text-gray-700 leading-relaxed" id="guide-plant">...</p>
                    </div>

                    <!-- Watering -->
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <h4 class="font-bold text-blue-800 mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-droplet text-blue-500"></i> ‡∏Å‡∏≤‡∏£‡∏£‡∏î‡∏ô‡πâ‡∏≥
                        </h4>
                        <p class="text-sm text-gray-700 leading-relaxed" id="guide-water">...</p>
                    </div>

                    <!-- Fertilizer -->
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                        <h4 class="font-bold text-yellow-800 mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-poop text-yellow-600"></i> ‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ & ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà
                        </h4>
                        <p class="text-sm text-gray-700 leading-relaxed" id="guide-fertilizer">...</p>
                    </div>

                </div>

            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl sm:rounded-b-2xl" id="modal-footer-action">
                <button onclick="saveSchedule()" class="w-full bg-leaf-600 hover:bg-leaf-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-leaf-500/30 active:scale-95 transition" id="save-btn">
                    <i class="fa-regular fa-floppy-disk mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏•‡∏π‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation Bottom Bar (Mobile) -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around py-3 pb-safe z-50 shadow-[0_-5px_10px_rgba(0,0,0,0.05)] md:hidden">
        <button onclick="toggleView('calendar')" class="flex flex-col items-center gap-1 text-leaf-600">
            <i class="fa-solid fa-calendar-check text-xl"></i>
            <span class="text-[10px]">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏•‡∏π‡∏Å</span>
        </button>
        <button onclick="toggleView('schedule')" class="flex flex-col items-center gap-1 text-gray-400 hover:text-leaf-600" id="nav-schedule">
            <div class="relative">
                <i class="fa-solid fa-list-check text-xl"></i>
                <span id="nav-badge" class="absolute -top-1 -right-2 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full hidden">0</span>
            </div>
            <span class="text-[10px]">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</span>
        </button>
        <!-- ‡∏õ‡∏∏‡πà‡∏° ‡∏ï‡∏•‡∏≤‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πâ -->
        <button onclick="openMarketModal()" class="flex flex-col items-center gap-1 text-gray-400 hover:text-market-600">
            <i class="fa-solid fa-shop text-xl"></i>
            <span class="text-[10px]">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πâ</span>
        </button>
    </div>

    <!-- Market Modal (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤) -->
    <div id="market-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center px-0 sm:px-4 backdrop-blur-sm">
        <div class="bg-white w-full h-full sm:h-[600px] sm:max-w-lg sm:rounded-2xl flex flex-col animate-pop relative overflow-hidden">
            <!-- Header -->
            <div class="p-4 bg-market-600 text-white shadow-md z-10">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i class="fa-solid fa-money-bill-trend-up"></i> ‡∏ï‡∏•‡∏≤‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πâ
                        </h3>
                        <p class="text-xs text-white/80" id="market-last-update">‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</p>
                    </div>
                    <button onclick="closeMarketModal()" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <!-- Market Tabs -->
                <div class="flex gap-2 mt-2">
                    <button onclick="switchMarketTab('fruit')" id="market-tab-fruit" class="flex-1 py-1.5 text-xs font-bold rounded-lg transition-colors market-tab-active border border-white/20">
                        <i class="fa-solid fa-apple-whole"></i> ‡∏ú‡∏•‡πÑ‡∏°‡πâ
                    </button>
                    <button onclick="switchMarketTab('veg')" id="market-tab-veg" class="flex-1 py-1.5 text-xs font-bold rounded-lg transition-colors market-tab-inactive border border-white/20">
                        <i class="fa-solid fa-carrot"></i> ‡∏ú‡∏±‡∏Å
                    </button>
                </div>
            </div>
            
            <!-- Table Area -->
            <div class="flex-grow overflow-y-auto bg-slate-50 custom-scrollbar relative">
                <div id="loading-indicator" class="hidden absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center text-gray-400">
                    <i class="fa-solid fa-circle-notch text-4xl animate-spin-slow mb-2 text-market-500"></i>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Backend...</p>
                </div>

                <table class="w-full market-table bg-white text-left hidden" id="market-table-content">
                    <thead class="sticky top-0 shadow-sm z-10">
                        <tr>
                            <th class="w-1/3">‡∏û‡∏∑‡∏ä</th>
                            <th>‡∏ï‡πâ‡∏ô<br><span class="text-[10px] font-normal">(‡∏ö./‡∏ï‡πâ‡∏ô)</span></th>
                            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏•<br><span class="text-[10px] font-normal">(‡∏ö./‡∏Å‡∏Å.)</span></th>
                            <th class="text-center">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</th>
                        </tr>
                    </thead>
                    <tbody id="market-tbody">
                        <!-- JS inject rows -->
                    </tbody>
                </table>
            </div>
            
            <!-- Footer Action -->
            <div class="p-4 bg-white border-t border-gray-200">
                <button onclick="updateMarketData()" class="w-full bg-market-600 hover:bg-market-700 text-white py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 transition active:scale-95">
                    <i class="fa-solid fa-rotate"></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤
                </button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculator-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl shadow-2xl animate-pop overflow-hidden">
            <!-- Header -->
            <div class="bg-gray-800 text-white p-3 flex justify-between items-center">
                <h3 class="font-bold"><i class="fa-solid fa-calculator mr-2"></i>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç</h3>
                <button onclick="closeCalculator()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <!-- Display -->
            <div class="bg-gray-100 p-4 border-b border-gray-200">
                <input type="text" id="calc-display" class="w-full bg-transparent text-right text-3xl font-mono outline-none text-gray-800" readonly value="0">
            </div>
            <!-- Keypad -->
            <div class="grid grid-cols-4 gap-1 p-2 bg-gray-50">
                <button onclick="calcClear()" class="col-span-3 bg-red-100 text-red-600 p-3 rounded hover:bg-red-200 font-bold">C</button>
                <button onclick="calcAppend('/')" class="bg-orange-100 text-orange-600 p-3 rounded hover:bg-orange-200 font-bold">√∑</button>
                
                <button onclick="calcAppend('7')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">7</button>
                <button onclick="calcAppend('8')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">8</button>
                <button onclick="calcAppend('9')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">9</button>
                <button onclick="calcAppend('*')" class="bg-orange-100 text-orange-600 p-3 rounded hover:bg-orange-200 font-bold">√ó</button>
                
                <button onclick="calcAppend('4')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">4</button>
                <button onclick="calcAppend('5')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">5</button>
                <button onclick="calcAppend('6')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">6</button>
                <button onclick="calcAppend('-')" class="bg-orange-100 text-orange-600 p-3 rounded hover:bg-orange-200 font-bold">-</button>
                
                <button onclick="calcAppend('1')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">1</button>
                <button onclick="calcAppend('2')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">2</button>
                <button onclick="calcAppend('3')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">3</button>
                <button onclick="calcAppend('+')" class="bg-orange-100 text-orange-600 p-3 rounded hover:bg-orange-200 font-bold">+</button>
                
                <button onclick="calcAppend('0')" class="col-span-2 bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">0</button>
                <button onclick="calcAppend('.')" class="bg-white shadow-sm p-3 rounded hover:bg-gray-100 font-bold text-lg">.</button>
                <button onclick="calcEqual()" class="bg-green-500 text-white p-3 rounded hover:bg-green-600 font-bold shadow">=</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const BACKEND_URL = 'https://mute-unit-1629.tontakankeawpang.workers.dev/';

        // --- Data: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡∏ä ---
        const allCrops = [
            // --- ‡∏ú‡∏•‡πÑ‡∏°‡πâ (Fruits) ---
            { id: 1, type: 'fruit', name: "‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á", icon: "ü•≠", fertilizeDays: 30, harvestDays: 120, months: [0, 1, 2, 3], seedBase: 15, saplingBase: 40 },
            { id: 2, type: 'fruit', name: "‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", icon: "üçà", fertilizeDays: 45, harvestDays: 150, months: [3, 4, 5], seedBase: 200, saplingBase: 250 },
            { id: 3, type: 'fruit', name: "‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î", icon: "üü£", fertilizeDays: 40, harvestDays: 130, months: [4, 5, 6], seedBase: 10, saplingBase: 80 },
            { id: 4, type: 'fruit', name: "‡πÄ‡∏á‡∏≤‡∏∞", icon: "üî¥", fertilizeDays: 35, harvestDays: 120, months: [4, 5, 6], seedBase: 5, saplingBase: 50 },
            { id: 5, type: 'fruit', name: "‡∏•‡∏≥‡πÑ‡∏¢", icon: "üü§", fertilizeDays: 40, harvestDays: 140, months: [5, 6, 7], seedBase: 10, saplingBase: 60 },
            { id: 6, type: 'fruit', name: "‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ", icon: "üçì", fertilizeDays: 20, harvestDays: 75, months: [9, 10, 11, 0], seedBase: 20, saplingBase: 15 },
            { id: 7, type: 'fruit', name: "‡∏Å‡∏•‡πâ‡∏ß‡∏¢", icon: "üçå", fertilizeDays: 60, harvestDays: 240, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 0, saplingBase: 25 }, 
            { id: 8, type: 'fruit', name: "‡∏°‡∏∞‡∏•‡∏∞‡∏Å‡∏≠", icon: "ü•ì", fertilizeDays: 45, harvestDays: 180, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 50, saplingBase: 15 },
            { id: 9, type: 'fruit', name: "‡∏™‡πâ‡∏°", icon: "üçä", fertilizeDays: 50, harvestDays: 200, months: [8, 9, 10, 11], seedBase: 20, saplingBase: 70 },
            { id: 10, type: 'fruit', name: "‡πÅ‡∏ï‡∏á‡πÇ‡∏°", icon: "üçâ", fertilizeDays: 25, harvestDays: 65, months: [10, 11, 0, 1], seedBase: 45, saplingBase: 10 },
            { id: 11, type: 'fruit', name: "‡∏≠‡∏á‡∏∏‡πà‡∏ô", icon: "üçá", fertilizeDays: 30, harvestDays: 100, months: [10, 11, 0], seedBase: 0, saplingBase: 120 },
            { id: 12, type: 'fruit', name: "‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß", icon: "ü••", fertilizeDays: 90, harvestDays: 365, months: [5, 6, 7], seedBase: 50, saplingBase: 80 },
            { id: 13, type: 'fruit', name: "‡∏ù‡∏£‡∏±‡πà‡∏á", icon: "üçè", fertilizeDays: 30, harvestDays: 240, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 10, saplingBase: 40 },
            { id: 14, type: 'fruit', name: "‡∏Ç‡∏ô‡∏∏‡∏ô", icon: "üçà", fertilizeDays: 60, harvestDays: 365, months: [3, 4, 5], seedBase: 15, saplingBase: 60 },
            { id: 15, type: 'fruit', name: "‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡πà‡∏≤", icon: "üçè", fertilizeDays: 45, harvestDays: 150, months: [5, 6, 7], seedBase: 5, saplingBase: 35 },
            { id: 16, type: 'fruit', name: "‡πÅ‡∏Å‡πâ‡∏ß‡∏°‡∏±‡∏á‡∏Å‡∏£", icon: "üê≤", fertilizeDays: 30, harvestDays: 180, months: [4, 5, 6, 7, 8, 9, 10], seedBase: 0, saplingBase: 20 },
            { id: 17, type: 'fruit', name: "‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î", icon: "üçç", fertilizeDays: 60, harvestDays: 540, months: [3, 4, 5, 10, 11], seedBase: 0, saplingBase: 10 },
            { id: 18, type: 'fruit', name: "‡∏ä‡∏°‡∏û‡∏π‡πà", icon: "üçé", fertilizeDays: 30, harvestDays: 120, months: [0, 1, 2, 11], seedBase: 10, saplingBase: 80 },
            { id: 19, type: 'fruit', name: "‡∏™‡πâ‡∏°‡πÇ‡∏≠", icon: "üü¢", fertilizeDays: 60, harvestDays: 240, months: [7, 8, 9], seedBase: 20, saplingBase: 150 },
            { id: 20, type: 'fruit', name: "‡∏°‡∏∞‡∏ô‡∏≤‡∏ß", icon: "üçã", fertilizeDays: 30, harvestDays: 150, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 5, saplingBase: 30 },
            { id: 21, type: 'fruit', name: "‡πÄ‡∏™‡∏≤‡∏ß‡∏£‡∏™", icon: "üü£", fertilizeDays: 45, harvestDays: 180, months: [5, 6, 7, 8], seedBase: 10, saplingBase: 25 },
            { id: 22, type: 'fruit', name: "‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà", icon: "üçí", fertilizeDays: 40, harvestDays: 120, months: [3, 4, 5], seedBase: 15, saplingBase: 80 },
            { id: 23, type: 'fruit', name: "‡∏•‡∏≠‡∏á‡∏Å‡∏≠‡∏á", icon: "üçá", fertilizeDays: 60, harvestDays: 180, months: [7, 8, 9], seedBase: 0, saplingBase: 60 },
            { id: 24, type: 'fruit', name: "‡∏°‡∏∞‡∏¢‡∏á‡∏ä‡∏¥‡∏î", icon: "üü†", fertilizeDays: 45, harvestDays: 100, months: [1, 2, 3], seedBase: 0, saplingBase: 250 },
            { id: 25, type: 'fruit', name: "‡∏•‡∏∞‡∏°‡∏∏‡∏î", icon: "ü•î", fertilizeDays: 40, harvestDays: 200, months: [8, 9, 10, 11], seedBase: 10, saplingBase: 50 },
            { id: 26, type: 'fruit', name: "‡∏Å‡∏£‡∏∞‡∏ó‡πâ‡∏≠‡∏ô", icon: "üçë", fertilizeDays: 50, harvestDays: 150, months: [4, 5, 6], seedBase: 10, saplingBase: 40 },
            { id: 27, type: 'fruit', name: "‡∏û‡∏∏‡∏ó‡∏£‡∏≤", icon: "üü¢", fertilizeDays: 30, harvestDays: 210, months: [7, 8, 9, 10], seedBase: 5, saplingBase: 35 },
            { id: 28, type: 'fruit', name: "‡∏≠‡∏∞‡πÇ‡∏ß‡∏Ñ‡∏≤‡πÇ‡∏î", icon: "ü•ë", fertilizeDays: 60, harvestDays: 300, months: [8, 9, 10, 11], seedBase: 40, saplingBase: 120 },
            { id: 29, type: 'fruit', name: "‡∏ó‡∏±‡∏ö‡∏ó‡∏¥‡∏°", icon: "üî¥", fertilizeDays: 45, harvestDays: 180, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 20, saplingBase: 50 },
            { id: 30, type: 'fruit', name: "‡∏°‡∏∞‡πÄ‡∏ü‡∏∑‡∏≠‡∏á", icon: "‚≠ê", fertilizeDays: 30, harvestDays: 150, months: [5, 6, 7, 8], seedBase: 10, saplingBase: 40 },
            { id: 31, type: 'fruit', name: "‡πÅ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏•‡∏π‡∏õ", icon: "üçà", fertilizeDays: 25, harvestDays: 75, months: [0, 1, 2, 10, 11], seedBase: 50, saplingBase: 15 },
            { id: 32, type: 'fruit', name: "‡πÄ‡∏°‡∏•‡πà‡∏≠‡∏ô", icon: "üçà", fertilizeDays: 30, harvestDays: 80, months: [0, 1, 2, 9, 10, 11], seedBase: 60, saplingBase: 20 },

            // --- ‡∏ú‡∏±‡∏Å‡∏™‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß (Vegetables) ---
            { id: 101, type: 'veg', name: "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î", icon: "üåΩ", fertilizeDays: 20, harvestDays: 70, months: [9, 10, 11, 0, 1], seedBase: 30, saplingBase: 5 },
            { id: 102, type: 'veg', name: "‡∏û‡∏£‡∏¥‡∏Å", icon: "üå∂Ô∏è", fertilizeDays: 30, harvestDays: 90, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 25, saplingBase: 5 },
            { id: 103, type: 'veg', name: "‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®", icon: "üçÖ", fertilizeDays: 25, harvestDays: 60, months: [9, 10, 11, 0], seedBase: 30, saplingBase: 5 },
            { id: 104, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á", icon: "üåø", fertilizeDays: 10, harvestDays: 25, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 10, saplingBase: 0 },
            { id: 105, type: 'veg', name: "‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤", icon: "ü•¨", fertilizeDays: 20, harvestDays: 45, months: [9, 10, 11, 0, 1], seedBase: 15, saplingBase: 2 },
            { id: 106, type: 'veg', name: "‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏∏‡πâ‡∏á", icon: "ü•¨", fertilizeDays: 15, harvestDays: 35, months: [9, 10, 11, 0, 1], seedBase: 15, saplingBase: 2 },
            { id: 107, type: 'veg', name: "‡∏Å‡∏∞‡∏´‡∏•‡πà‡∏≥‡∏õ‡∏•‡∏µ", icon: "ü•ó", fertilizeDays: 30, harvestDays: 90, months: [10, 11, 0], seedBase: 20, saplingBase: 5 },
            { id: 108, type: 'veg', name: "‡∏ñ‡∏±‡πà‡∏ß‡∏ù‡∏±‡∏Å‡∏¢‡∏≤‡∏ß", icon: "ü•í", fertilizeDays: 20, harvestDays: 55, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 20, saplingBase: 0 },
            { id: 109, type: 'veg', name: "‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤", icon: "ü•í", fertilizeDays: 15, harvestDays: 35, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 15, saplingBase: 0 },
            { id: 110, type: 'veg', name: "‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏õ‡∏£‡∏≤‡∏∞", icon: "üçÜ", fertilizeDays: 30, harvestDays: 60, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 20, saplingBase: 5 },
            { id: 111, type: 'veg', name: "‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡∏¢‡∏≤‡∏ß", icon: "üçÜ", fertilizeDays: 30, harvestDays: 70, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 20, saplingBase: 5 },
            { id: 112, type: 'veg', name: "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤", icon: "üçÉ", fertilizeDays: 20, harvestDays: 45, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 10, saplingBase: 10 },
            { id: 113, type: 'veg', name: "‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤", icon: "üçÉ", fertilizeDays: 20, harvestDays: 45, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 10, saplingBase: 10 },
            { id: 114, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏ä‡∏µ", icon: "üåø", fertilizeDays: 20, harvestDays: 45, months: [9, 10, 11, 0], seedBase: 30, saplingBase: 0 },
            { id: 115, type: 'veg', name: "‡∏ï‡πâ‡∏ô‡∏´‡∏≠‡∏°", icon: "üå±", fertilizeDays: 20, harvestDays: 45, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 40, saplingBase: 0 },
            { id: 116, type: 'veg', name: "‡∏Ç‡∏∂‡πâ‡∏ô‡∏â‡πà‡∏≤‡∏¢", icon: "üåø", fertilizeDays: 30, harvestDays: 60, months: [9, 10, 11, 0], seedBase: 25, saplingBase: 0 },
            { id: 117, type: 'veg', name: "‡∏ï‡∏∞‡πÑ‡∏Ñ‡∏£‡πâ", icon: "üåæ", fertilizeDays: 45, harvestDays: 120, months: [4, 5, 6], seedBase: 0, saplingBase: 5 },
            { id: 118, type: 'veg', name: "‡∏Ç‡πà‡∏≤", icon: "ü•î", fertilizeDays: 60, harvestDays: 240, months: [4, 5, 6], seedBase: 0, saplingBase: 10 },
            { id: 119, type: 'veg', name: "‡∏ü‡∏±‡∏Å‡∏ó‡∏≠‡∏á", icon: "üéÉ", fertilizeDays: 30, harvestDays: 90, months: [9, 10, 11, 0], seedBase: 20, saplingBase: 5 },
            { id: 120, type: 'veg', name: "‡∏ü‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", icon: "üçà", fertilizeDays: 30, harvestDays: 70, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 15, saplingBase: 5 },
            { id: 121, type: 'veg', name: "‡∏ö‡∏ß‡∏ö", icon: "ü•í", fertilizeDays: 20, harvestDays: 50, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 15, saplingBase: 0 },
            { id: 122, type: 'veg', name: "‡∏°‡∏∞‡∏£‡∏∞", icon: "ü•í", fertilizeDays: 25, harvestDays: 60, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 20, saplingBase: 5 },
            { id: 123, type: 'veg', name: "‡∏ï‡∏≥‡∏•‡∏∂‡∏á", icon: "üçÉ", fertilizeDays: 30, harvestDays: 60, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 10, saplingBase: 5 },
            { id: 124, type: 'veg', name: "‡∏ä‡∏∞‡∏≠‡∏°", icon: "üåø", fertilizeDays: 30, harvestDays: 90, months: [4, 5, 6], seedBase: 10, saplingBase: 15 },
            { id: 125, type: 'veg', name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", icon: "üå∂Ô∏è", fertilizeDays: 25, harvestDays: 55, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 15, saplingBase: 0 },
            { id: 126, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°", icon: "ü•ó", fertilizeDays: 20, harvestDays: 45, months: [9, 10, 11, 0, 1], seedBase: 20, saplingBase: 2 },
            { id: 127, type: 'veg', name: "‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ", icon: "ü•¶", fertilizeDays: 30, harvestDays: 75, months: [10, 11, 0], seedBase: 40, saplingBase: 5 },
            { id: 128, type: 'veg', name: "‡∏Å‡∏∞‡∏´‡∏•‡πà‡∏≥‡∏î‡∏≠‡∏Å", icon: "ü•¶", fertilizeDays: 30, harvestDays: 80, months: [10, 11, 0], seedBase: 35, saplingBase: 5 },
            { id: 129, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°", icon: "üçÉ", fertilizeDays: 15, harvestDays: 35, months: [9, 10, 11, 0, 1], seedBase: 15, saplingBase: 0 },
            { id: 130, type: 'veg', name: "‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏ù‡∏£‡∏±‡πà‡∏á", icon: "üéã", fertilizeDays: 90, harvestDays: 240, months: [0, 1, 10, 11], seedBase: 50, saplingBase: 20 },
            { id: 131, type: 'veg', name: "‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó", icon: "ü•ï", fertilizeDays: 30, harvestDays: 90, months: [10, 11, 0], seedBase: 25, saplingBase: 0 },
            { id: 132, type: 'veg', name: "‡∏´‡∏±‡∏ß‡πÑ‡∏ä‡πÄ‡∏ó‡πâ‡∏≤", icon: "üêá", fertilizeDays: 20, harvestDays: 50, months: [10, 11, 0], seedBase: 15, saplingBase: 0 },
            { id: 133, type: 'veg', name: "‡∏´‡∏≠‡∏°‡πÅ‡∏î‡∏á", icon: "üßÖ", fertilizeDays: 30, harvestDays: 70, months: [10, 11, 0], seedBase: 40, saplingBase: 0 },
            { id: 134, type: 'veg', name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", icon: "üßÑ", fertilizeDays: 30, harvestDays: 100, months: [10, 11, 0], seedBase: 50, saplingBase: 0 },
            { id: 135, type: 'veg', name: "‡∏Ç‡∏¥‡∏á", icon: "üç†", fertilizeDays: 60, harvestDays: 240, months: [3, 4, 5], seedBase: 30, saplingBase: 0 },
            { id: 136, type: 'veg', name: "‡∏Ç‡∏°‡∏¥‡πâ‡∏ô", icon: "üü®", fertilizeDays: 60, harvestDays: 240, months: [4, 5, 6], seedBase: 20, saplingBase: 0 },
            { id: 137, type: 'veg', name: "‡∏Å‡∏£‡∏∞‡∏ä‡∏≤‡∏¢", icon: "ü•î", fertilizeDays: 60, harvestDays: 240, months: [4, 5, 6], seedBase: 20, saplingBase: 0 },
            { id: 138, type: 'veg', name: "‡∏°‡∏∞‡∏Å‡∏£‡∏π‡∏î", icon: "üçã", fertilizeDays: 90, harvestDays: 365, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 20, saplingBase: 50 },
            { id: 139, type: 'veg', name: "‡∏™‡∏∞‡∏£‡∏∞‡πÅ‡∏´‡∏ô‡πà", icon: "üåø", fertilizeDays: 15, harvestDays: 45, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 0, saplingBase: 10 },
            { id: 140, type: 'veg', name: "‡∏°‡∏±‡∏ô‡πÄ‡∏ó‡∏®", icon: "üç†", fertilizeDays: 30, harvestDays: 100, months: [9, 10, 11, 0, 1], seedBase: 10, saplingBase: 5 },
            { id: 141, type: 'veg', name: "‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å", icon: "ü•î", fertilizeDays: 60, harvestDays: 200, months: [4, 5, 6], seedBase: 20, saplingBase: 10 },
            { id: 142, type: 'veg', name: "‡∏ñ‡∏±‡πà‡∏ß‡∏û‡∏π", icon: "ü•í", fertilizeDays: 30, harvestDays: 90, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 15, saplingBase: 0 },
            { id: 143, type: 'veg', name: "‡∏ñ‡∏±‡πà‡∏ß‡∏•‡∏¥‡∏™‡∏á", icon: "ü•ú", fertilizeDays: 30, harvestDays: 100, months: [0, 1, 5, 6, 9, 10], seedBase: 25, saplingBase: 0 },
            { id: 144, type: 'veg', name: "‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤", icon: "üçê", fertilizeDays: 30, harvestDays: 70, months: [9, 10, 11, 0], seedBase: 15, saplingBase: 5 },
            { id: 145, type: 'veg', name: "‡∏î‡∏≠‡∏Å‡πÅ‡∏Ñ", icon: "üåº", fertilizeDays: 60, harvestDays: 120, months: [5, 6, 7], seedBase: 10, saplingBase: 20 },
            { id: 146, type: 'veg', name: "‡∏™‡∏∞‡πÄ‡∏î‡∏≤", icon: "üåø", fertilizeDays: 90, harvestDays: 365, months: [5, 6, 7], seedBase: 15, saplingBase: 40 },
            { id: 147, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏â‡∏î", icon: "üåø", fertilizeDays: 15, harvestDays: 40, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 0, saplingBase: 10 },
            { id: 148, type: 'veg', name: "‡∏Å‡∏∏‡∏¢‡∏ä‡πà‡∏≤‡∏¢", icon: "ü•¨", fertilizeDays: 30, harvestDays: 90, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 20, saplingBase: 5 },
            { id: 149, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏ä‡∏µ‡∏ù‡∏£‡∏±‡πà‡∏á", icon: "üåø", fertilizeDays: 30, harvestDays: 90, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 25, saplingBase: 5 },
            { id: 150, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏ä‡∏µ‡∏•‡∏≤‡∏ß", icon: "üåø", fertilizeDays: 20, harvestDays: 50, months: [9, 10, 11, 0], seedBase: 20, saplingBase: 0 },
            { id: 151, type: 'veg', name: "‡πÅ‡∏°‡∏á‡∏•‡∏±‡∏Å", icon: "üçÉ", fertilizeDays: 20, harvestDays: 50, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 10, saplingBase: 0 },
            { id: 152, type: 'veg', name: "‡πÉ‡∏ö‡∏ö‡∏±‡∏ß‡∏ö‡∏Å", icon: "üçÄ", fertilizeDays: 20, harvestDays: 60, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 0, saplingBase: 10 },
            { id: 153, type: 'veg', name: "‡πÄ‡∏ï‡∏¢‡∏´‡∏≠‡∏°", icon: "üåø", fertilizeDays: 60, harvestDays: 180, months: [5, 6, 7], seedBase: 0, saplingBase: 15 },
            { id: 154, type: 'veg', name: "‡∏Å‡∏£‡∏∞‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö‡πÅ‡∏î‡∏á", icon: "üå∫", fertilizeDays: 30, harvestDays: 120, months: [8, 9, 10], seedBase: 10, saplingBase: 0 },
            { id: 155, type: 'veg', name: "‡∏≠‡∏±‡∏ç‡∏ä‡∏±‡∏ô", icon: "üå∏", fertilizeDays: 30, harvestDays: 90, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 10, saplingBase: 15 },
            { id: 156, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏Ç‡∏≤‡∏ß", icon: "ü•¨", fertilizeDays: 20, harvestDays: 50, months: [10, 11, 0, 1], seedBase: 20, saplingBase: 0 },
            { id: 157, type: 'veg', name: "‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏∏‡πâ‡∏á‡∏Æ‡πà‡∏≠‡∏á‡πÄ‡∏ï‡πâ", icon: "ü•¨", fertilizeDays: 20, harvestDays: 45, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 20, saplingBase: 0 },
            { id: 158, type: 'veg', name: "‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ", icon: "ü•ó", fertilizeDays: 20, harvestDays: 45, months: [10, 11, 0, 1], seedBase: 25, saplingBase: 5 },
            { id: 159, type: 'veg', name: "‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ", icon: "ü•ó", fertilizeDays: 20, harvestDays: 45, months: [10, 11, 0, 1], seedBase: 25, saplingBase: 5 },
            { id: 160, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏Ñ‡∏≠‡∏™", icon: "ü•ó", fertilizeDays: 20, harvestDays: 45, months: [10, 11, 0, 1], seedBase: 25, saplingBase: 5 },
            { id: 161, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏õ‡∏•‡∏±‡∏á", icon: "üåø", fertilizeDays: 20, harvestDays: 50, months: [5, 6, 7], seedBase: 10, saplingBase: 5 },
            { id: 162, type: 'veg', name: "‡∏ü‡∏±‡∏Å‡∏Ç‡πâ‡∏≤‡∏ß", icon: "üü†", fertilizeDays: 60, harvestDays: 240, months: [5, 6, 7], seedBase: 20, saplingBase: 50 },
            { id: 163, type: 'veg', name: "‡∏ö‡∏ß‡∏ö‡∏á‡∏π", icon: "üêç", fertilizeDays: 30, harvestDays: 60, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 15, saplingBase: 0 },
            { id: 164, type: 'veg', name: "‡∏ñ‡∏±‡πà‡∏ß‡∏•‡∏±‡∏ô‡πÄ‡∏ï‡∏≤", icon: "ü•ú", fertilizeDays: 30, harvestDays: 70, months: [10, 11, 0], seedBase: 30, saplingBase: 0 },
            { id: 165, type: 'veg', name: "‡∏´‡∏≠‡∏°‡∏´‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà", icon: "üßÖ", fertilizeDays: 40, harvestDays: 120, months: [10, 11, 0], seedBase: 50, saplingBase: 0 },
            { id: 166, type: 'veg', name: "‡∏°‡∏±‡∏ô‡∏ù‡∏£‡∏±‡πà‡∏á", icon: "ü•î", fertilizeDays: 40, harvestDays: 100, months: [10, 11, 0], seedBase: 30, saplingBase: 0 },
            { id: 167, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏´‡∏ß‡∏≤‡∏ô‡∏õ‡πà‡∏≤", icon: "üåø", fertilizeDays: 120, harvestDays: 730, months: [5, 6], seedBase: 50, saplingBase: 100 },
            { id: 168, type: 'veg', name: "‡∏ú‡∏±‡∏Å‡∏Å‡∏π‡∏î", icon: "üåø", fertilizeDays: 30, harvestDays: 90, months: [5, 6, 7, 8], seedBase: 0, saplingBase: 20 },
            { id: 169, type: 'veg', name: "‡∏¢‡∏µ‡πà‡∏´‡∏£‡πà‡∏≤", icon: "üçÉ", fertilizeDays: 30, harvestDays: 70, months: [0,1,2,3,4,5,6,7,8,9,10,11], seedBase: 15, saplingBase: 10 },
            { id: 170, type: 'veg', name: "‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏ó‡∏¢", icon: "‚ö´", fertilizeDays: 90, harvestDays: 365, months: [5, 6, 7], seedBase: 0, saplingBase: 50 }
        ];

        const monthNames = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
        
        // --- Global State ---
        let currentSelectedDate = new Date();
        let currentMonthIndex = currentSelectedDate.getMonth();
        let currentCategory = 'fruit'; // 'fruit' or 'veg'
        let currentMarketCategory = 'fruit'; // 'fruit' or 'veg' for market view
        let currentPlanting = null; 
        let mySchedules = JSON.parse(localStorage.getItem('myPlantingSchedule')) || [];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const datePicker = document.getElementById('global-date-picker');
            datePicker.valueAsDate = currentSelectedDate;
            
            updateHeaderAndSeason();
            renderCrops();
            renderScheduleList();
            
            document.getElementById('start-date').valueAsDate = new Date();
            document.getElementById('start-date').addEventListener('change', calculateDates);

            document.getElementById('search-input').addEventListener('input', (e) => {
                const keyword = e.target.value.toLowerCase();
                const filtered = allCrops.filter(f => 
                    f.name.toLowerCase().includes(keyword) && f.type === currentCategory
                );
                renderFilteredCrops(filtered);
                document.getElementById('filter-status').innerText = keyword ? `‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${keyword}"` : "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
            });

            datePicker.addEventListener('change', (e) => {
                currentSelectedDate = new Date(e.target.value);
                currentMonthIndex = currentSelectedDate.getMonth();
                updateHeaderAndSeason();
            });

            renderMarketTable(false); 
        });

        // --- Logic: Category Switching (Main View) ---
        function switchCategory(type) {
            currentCategory = type;
            const btnFruit = document.getElementById('tab-fruit');
            const btnVeg = document.getElementById('tab-veg');
            
            if(type === 'fruit') {
                btnFruit.classList.add('tab-active');
                btnFruit.classList.remove('tab-inactive');
                btnVeg.classList.add('tab-inactive');
                btnVeg.classList.remove('tab-active');
            } else {
                btnVeg.classList.add('tab-active');
                btnVeg.classList.remove('tab-inactive');
                btnFruit.classList.add('tab-inactive');
                btnFruit.classList.remove('tab-active');
            }
            
            document.getElementById('search-input').value = "";
            document.getElementById('filter-status').innerText = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
            renderCrops();
        }

        // --- Logic: Market Category Switching ---
        function switchMarketTab(type) {
            currentMarketCategory = type;
            const btnFruit = document.getElementById('market-tab-fruit');
            const btnVeg = document.getElementById('market-tab-veg');
            
            if(type === 'fruit') {
                btnFruit.classList.add('market-tab-active');
                btnFruit.classList.remove('market-tab-inactive');
                btnVeg.classList.add('market-tab-inactive');
                btnVeg.classList.remove('market-tab-active');
            } else {
                btnVeg.classList.add('market-tab-active');
                btnVeg.classList.remove('market-tab-inactive');
                btnFruit.classList.add('market-tab-inactive');
                btnFruit.classList.remove('market-tab-active');
            }
            renderMarketTable(false); 
        }

        // --- Logic: Modal Tab Switching ---
        function switchModalTab(tab) {
            const btnTimeline = document.getElementById('mtab-timeline');
            const btnGuide = document.getElementById('mtab-guide');
            const contentTimeline = document.getElementById('modal-content-timeline');
            const contentGuide = document.getElementById('modal-content-guide');
            
            if (tab === 'timeline') {
                btnTimeline.classList.add('modal-tab-active');
                btnTimeline.classList.remove('modal-tab-inactive');
                btnGuide.classList.add('modal-tab-inactive');
                btnGuide.classList.remove('modal-tab-active');
                
                contentTimeline.classList.remove('hidden');
                contentGuide.classList.add('hidden');
            } else {
                btnGuide.classList.add('modal-tab-active');
                btnGuide.classList.remove('modal-tab-inactive');
                btnTimeline.classList.add('modal-tab-inactive');
                btnTimeline.classList.remove('modal-tab-active');
                
                contentGuide.classList.remove('hidden');
                contentTimeline.classList.add('hidden');
            }
        }

        function updateHeaderAndSeason() {
            const month = currentSelectedDate.getMonth(); 
            let season = "";
            let icon = "";
            let gradientClass = "";

            if (month >= 1 && month <= 4) { 
                season = "‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô"; 
                icon = "fa-sun";
                gradientClass = "from-orange-500 to-red-500";
            } else if (month >= 5 && month <= 9) { 
                season = "‡∏§‡∏î‡∏π‡∏ù‡∏ô"; 
                icon = "fa-cloud-showers-heavy";
                gradientClass = "from-blue-500 to-teal-500";
            } else { 
                season = "‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß"; 
                icon = "fa-snowflake";
                gradientClass = "from-indigo-500 to-purple-500";
            }
            
            document.getElementById('current-season-display').innerText = season;
            
            const seasonIcon = document.getElementById('season-icon-small');
            const bgIcon = document.getElementById('season-icon-bg');
            const headerBg = document.getElementById('season-header-bg');

            seasonIcon.className = `fa-solid ${icon} text-2xl opacity-80`;
            bgIcon.className = `fa-solid ${icon} text-6xl absolute -right-2 -top-2 opacity-20`;
            headerBg.className = `rounded-2xl p-5 shadow-lg mb-4 text-white relative overflow-hidden transition-all duration-500 bg-gradient-to-r ${gradientClass}`;
        }

        function filterCurrentMonth() {
            const currentMonthList = allCrops.filter(f => f.type === currentCategory && f.months.includes(currentMonthIndex));
            renderFilteredCrops(currentMonthList);
            document.getElementById('filter-status').innerText = `‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNames[currentMonthIndex]}`;
            document.getElementById('search-input').value = "";
        }

        // --- Market Logic ---
        function openMarketModal() {
            switchMarketTab(currentCategory);
            document.getElementById('market-modal').classList.remove('hidden');
        }

        function closeMarketModal() {
            document.getElementById('market-modal').classList.add('hidden');
        }

        async function updateMarketData() {
            const loading = document.getElementById('loading-indicator');
            const table = document.getElementById('market-table-content');
            
            table.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'get_prices', 
                        date: currentSelectedDate.toISOString(),
                        category: currentMarketCategory
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("Backend reached:", data);
                    await new Promise(r => setTimeout(r, 800));
                } else {
                    throw new Error("Backend error");
                }
                
                renderMarketTable(true); 
                const now = new Date();
                const timeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('market-last-update').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Online): ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr}`;

            } catch (e) {
                console.warn("Backend unavailable, using simulation.", e);
                await new Promise(r => setTimeout(r, 1000));
                renderMarketTable(true);
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('market-last-update').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr}`;
            } finally {
                loading.classList.add('hidden');
                table.classList.remove('hidden');
            }
        }

        function renderMarketTable(randomize) {
            const tbody = document.getElementById('market-tbody');
            tbody.innerHTML = '';
            const table = document.getElementById('market-table-content');
            table.classList.remove('hidden');

            const displayedCrops = allCrops.filter(c => c.type === currentMarketCategory);

            displayedCrops.forEach(crop => {
                let seedPrice = crop.seedBase;
                let saplingPrice = crop.saplingBase;
                let trend = 'stable';

                if (randomize) {
                    const variation = (Math.random() * 0.4) - 0.2; 
                    seedPrice = Math.round(seedPrice * (1 + variation));
                    saplingPrice = Math.round(saplingPrice * (1 + variation));
                    
                    if(variation > 0.05) trend = 'up';
                    else if(variation < -0.05) trend = 'down';
                }
                
                let trendHtml = '<i class="fa-solid fa-minus trend-stable"></i>';
                if(trend === 'up') trendHtml = '<i class="fa-solid fa-arrow-trend-up trend-up"></i>';
                else if(trend === 'down') trendHtml = '<i class="fa-solid fa-arrow-trend-down trend-down"></i>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${crop.icon}</span>
                            <span class="font-medium text-gray-700">${crop.name}</span>
                        </div>
                    </td>
                    <td class="font-mono text-gray-600">${seedPrice > 0 ? seedPrice : '-'}</td>
                    <td class="font-mono text-gray-600">${saplingPrice > 0 ? saplingPrice : '-'}</td>
                    <td class="text-center">${trendHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- Render Lists ---
        function renderCrops() {
            const list = allCrops.filter(c => c.type === currentCategory);
            renderFilteredCrops(list);
        }

        function renderFilteredCrops(listToRender) {
            const container = document.getElementById('fruit-list');
            container.innerHTML = '';
            
            if(listToRender.length === 0) {
                const icon = currentCategory === 'fruit' ? 'fa-apple-whole' : 'fa-carrot';
                container.innerHTML = `<div class="p-8 text-center text-gray-400 bg-white rounded-xl border border-dashed"><i class="fa-solid ${icon} text-3xl mb-2"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
                return;
            }

            listToRender.forEach(crop => {
                const isRecommended = crop.months.includes(currentMonthIndex);
                const recommendBadge = isRecommended ? `<span class="bg-orange-100 text-orange-600 text-[10px] px-1.5 py-0.5 rounded ml-2">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>` : '';
                
                const btnColor = crop.type === 'fruit' ? 'bg-leaf-500' : 'bg-veg-600';
                const iconBg = crop.type === 'fruit' ? 'bg-leaf-50' : 'bg-lime-50';

                const item = document.createElement('div');
                item.className = 'bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between active:scale-[0.98] transition cursor-pointer';
                item.onclick = () => openCalcModal(crop);
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 ${iconBg} rounded-full flex items-center justify-center text-2xl">${crop.icon}</div>
                        <div>
                            <h4 class="font-bold text-gray-800 flex items-center">${crop.name} ${recommendBadge}</h4>
                            <p class="text-xs text-gray-500">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß: ${crop.harvestDays} ‡∏ß‡∏±‡∏ô</p>
                        </div>
                    </div>
                    <button class="${btnColor} text-white w-8 h-8 rounded-full shadow-sm flex items-center justify-center">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        // --- Image Upload Logic (Optimized) ---
        function triggerUpload(id) {
            document.getElementById(`file-${id}`).click();
        }

        function handleImageUpload(event, id) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to max 500x500 to save space
                    const MAX_WIDTH = 500;
                    const MAX_HEIGHT = 500;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress to JPEG 70% quality
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    const index = mySchedules.findIndex(item => item.id === id);
                    if (index !== -1) {
                        mySchedules[index].image = dataUrl;
                        try {
                            localStorage.setItem('myPlantingSchedule', JSON.stringify(mySchedules));
                            renderScheduleList();
                        } catch (err) {
                            alert("‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á");
                            console.error("Storage failed: ", err);
                        }
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Helper for Care Instructions ---
        function getCropCare(crop) {
            let care = { plant: "", water: "", fertilizer: "" };

            if (crop.type === 'fruit') {
                if (crop.name.includes("‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")) {
                    care.plant = "‡∏Ç‡∏∏‡∏î‡∏´‡∏•‡∏∏‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á 1 ‡πÄ‡∏°‡∏ï‡∏£ ‡∏•‡∏∂‡∏Å 50 ‡∏ã‡∏°. ‡∏£‡∏≠‡∏á‡∏Å‡πâ‡∏ô‡∏´‡∏•‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å ‡∏õ‡∏•‡∏π‡∏Å‡πÅ‡∏ö‡∏ö‡∏ô‡∏±‡πà‡∏á‡πÅ‡∏ó‡πà‡∏ô";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å ‡∏Ç‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏ï‡∏¥‡∏î‡∏™‡∏õ‡∏£‡∏¥‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ä‡πà‡∏ß‡∏¢";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏™‡∏°‡∏≠ (15-15-15) ‡∏õ‡∏µ‡∏•‡∏∞ 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï";
                } else if (crop.name.includes("‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á")) {
                    care.plant = "‡∏Ç‡∏∏‡∏î‡∏´‡∏•‡∏∏‡∏° 50x50x50 ‡∏ã‡∏°. ‡∏ú‡∏™‡∏°‡∏î‡∏¥‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥ 2-3 ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ó‡∏ô‡πÅ‡∏•‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏î‡∏µ";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏õ‡∏µ‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏ï‡πâ‡∏ô‡∏ù‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ù‡∏ô) ‡πÄ‡∏£‡πà‡∏á‡∏î‡∏≠‡∏Å‡πÉ‡∏ä‡πâ 8-24-24";
                } else if (crop.name.includes("‡∏Å‡∏•‡πâ‡∏ß‡∏¢")) {
                    care.plant = "‡∏Ç‡∏∏‡∏î‡∏´‡∏•‡∏∏‡∏°‡∏•‡∏∂‡∏Å 50 ‡∏ã‡∏°. ‡∏ß‡∏≤‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏ß‡∏¢ ‡∏Å‡∏•‡∏ö‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡∏ô";
                    care.water = "‡∏ä‡∏≠‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏≤‡∏Å ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏â‡∏∞";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏™‡∏°‡∏≠‡∏ó‡∏∏‡∏Å 2-3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
                } else if (crop.name.includes("‡∏°‡∏∞‡∏ô‡∏≤‡∏ß") || crop.name.includes("‡∏™‡πâ‡∏°")) {
                    care.plant = "‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏ß‡∏á‡∏ö‡πà‡∏≠‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡∏£‡πà‡∏≠‡∏á‡∏™‡∏ß‡∏ô";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏∏‡∏Å 1-2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏™‡∏°‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πã‡∏¢‡∏Ñ‡∏≠‡∏Å";
                } else {
                    care.plant = "‡∏Ç‡∏∏‡∏î‡∏´‡∏•‡∏∏‡∏°‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏£‡∏≠‡∏á‡∏Å‡πâ‡∏ô‡∏´‡∏•‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πã‡∏¢‡∏´‡∏°‡∏±‡∏Å ‡∏Å‡∏•‡∏ö‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡∏ô";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞ 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏™‡∏°‡∏≠ ‡∏õ‡∏µ‡∏•‡∏∞ 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                }
            } else { // Vegetable
                if (crop.name.includes("‡∏û‡∏£‡∏¥‡∏Å") || crop.name.includes("‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠")) {
                    care.plant = "‡πÄ‡∏û‡∏≤‡∏∞‡∏Å‡∏•‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô 30 ‡∏ß‡∏±‡∏ô ‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡πÅ‡∏õ‡∏•‡∏á ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á 50 ‡∏ã‡∏°.";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏∏‡∏Å 15 ‡∏ß‡∏±‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡πâ‡∏≤ 7 ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏™‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å";
                } else if (crop.name.includes("‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á") || crop.name.includes("‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤") || crop.name.includes("‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î")) {
                    care.plant = "‡∏´‡∏ß‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏•‡πá‡∏î‡∏•‡∏á‡πÅ‡∏õ‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏£‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß ‡∏Å‡∏•‡∏ö‡∏î‡∏¥‡∏ô‡∏ö‡∏≤‡∏á‡πÜ";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏ä‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏¢‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏™‡∏°‡∏≠‡∏ó‡∏∏‡∏Å 7-10 ‡∏ß‡∏±‡∏ô (‡πÉ‡∏™‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏£‡∏≠‡∏ö)";
                } else if (crop.name.includes("‡πÅ‡∏ï‡∏á") || crop.name.includes("‡∏ñ‡∏±‡πà‡∏ß") || crop.name.includes("‡∏ö‡∏ß‡∏ö")) {
                    care.plant = "‡∏´‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏∏‡∏°‡∏•‡∏∞ 3-4 ‡πÄ‡∏°‡∏•‡πá‡∏î ‡∏ó‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô‡πÉ‡∏ö‡∏°‡∏≤‡∏Å‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏∏‡∏Å 15-20 ‡∏ß‡∏±‡∏ô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏™‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÉ‡∏ö‡∏à‡∏£‡∏¥‡∏á 4-5 ‡πÉ‡∏ö";
                } else if (crop.name.includes("‡∏´‡∏≠‡∏°") || crop.name.includes("‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°")) {
                    care.plant = "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏ã‡∏∏‡∏¢ ‡∏õ‡∏±‡∏Å‡∏´‡∏±‡∏ß‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏•‡∏á‡∏î‡∏¥‡∏ô";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏û‡∏≠‡∏ä‡∏∏‡πà‡∏° ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏∏‡∏Å 15 ‡∏ß‡∏±‡∏ô (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)";
                } else {
                    care.plant = "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏£‡πà‡∏ß‡∏ô‡∏ã‡∏∏‡∏¢ ‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏•‡∏á‡πÅ‡∏õ‡∏•‡∏á";
                    care.water = "‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô";
                    care.fertilizer = "‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏∏‡∏Å 10-15 ‡∏ß‡∏±‡∏ô ‡∏à‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß";
                }
            }
            return care;
        }

        // --- Calculator Modal ---
        function openCalcModal(crop, existingDate = null) {
            currentPlanting = crop;
            
            document.getElementById('modal-icon').innerText = crop.icon;
            document.getElementById('modal-title').innerText = crop.name;
            document.getElementById('modal-desc').innerText = `‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${crop.harvestDays} ‡∏ß‡∏±‡∏ô`;
            document.getElementById('days-fertilize').innerText = crop.fertilizeDays;
            document.getElementById('days-harvest').innerText = crop.harvestDays;
            
            // Get Guide Text
            const care = getCropCare(crop);
            document.getElementById('guide-plant').innerText = care.plant;
            document.getElementById('guide-water').innerText = care.water;
            document.getElementById('guide-fertilizer').innerText = care.fertilizer;

            const dateInputContainer = document.getElementById('date-input-container');
            const saveBtn = document.getElementById('save-btn');
            const tabTimeline = document.getElementById('mtab-timeline');
            const tabGuide = document.getElementById('mtab-guide');

            // Date logic
            const dateInput = document.getElementById('start-date');
            
            if (existingDate) {
                // Viewing Mode
                dateInput.valueAsDate = existingDate;
                dateInputContainer.classList.add('hidden'); // Hide date input
                saveBtn.classList.add('hidden'); // Hide save button
                
                // Show guide tab primarily
                tabGuide.classList.remove('hidden');
                
                // Switch to Guide Tab by default
                switchModalTab('guide');
            } else {
                // Adding Mode
                dateInput.valueAsDate = currentSelectedDate;
                dateInputContainer.classList.remove('hidden'); // Show date input
                saveBtn.classList.remove('hidden'); // Show save button
                
                // Hide Guide Tab in selection mode
                tabGuide.classList.add('hidden');
                
                // Switch to Timeline Tab
                switchModalTab('timeline');
            }
            
            calculateDates();
            document.getElementById('calc-modal').classList.remove('hidden');
        }

        function closeCalcModal() {
            document.getElementById('calc-modal').classList.add('hidden');
        }

        function calculateDates() {
            if(!currentPlanting) return;

            const startDateInput = document.getElementById('start-date').value;
            if(!startDateInput) return;

            const start = new Date(startDateInput);
            
            const fertilize = new Date(start);
            fertilize.setDate(start.getDate() + currentPlanting.fertilizeDays);

            const harvest = new Date(start);
            harvest.setDate(start.getDate() + currentPlanting.harvestDays);

            document.getElementById('preview-start-date').innerText = formatDate(start);
            document.getElementById('preview-fertilize-date').innerText = formatDate(fertilize);
            document.getElementById('preview-harvest-date').innerText = formatDate(harvest);
        }

        function saveSchedule() {
            if(!currentPlanting) return;
            const startDateInput = document.getElementById('start-date').value;
            const start = new Date(startDateInput);
            
            const fertilize = new Date(start);
            fertilize.setDate(start.getDate() + currentPlanting.fertilizeDays);

            const harvest = new Date(start);
            harvest.setDate(start.getDate() + currentPlanting.harvestDays);

            const newSchedule = {
                id: Date.now(),
                fruitId: currentPlanting.id,
                name: currentPlanting.name,
                icon: currentPlanting.icon,
                startDate: start.toISOString(),
                fertilizeDate: fertilize.toISOString(),
                harvestDate: harvest.toISOString(),
                image: "" // Initialize with empty image
            };

            mySchedules.unshift(newSchedule); 
            localStorage.setItem('myPlantingSchedule', JSON.stringify(mySchedules));
            
            closeCalcModal();
            renderScheduleList();
            toggleView('schedule'); 
        }

        // --- Schedule View ---
        function renderScheduleList() {
            const list = document.getElementById('schedule-list');
            const emptyState = document.getElementById('empty-schedule');
            const countBadges = document.querySelectorAll('#schedule-count, #nav-badge');
            
            countBadges.forEach(el => {
                el.innerText = mySchedules.length;
                if(el.id === 'nav-badge') el.classList.toggle('hidden', mySchedules.length === 0);
            });

            if(mySchedules.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            list.innerHTML = '';

            mySchedules.forEach(item => {
                const start = new Date(item.startDate);
                const fertilize = new Date(item.fertilizeDate);
                const harvest = new Date(item.harvestDate);

                // Image Handling
                const hasImage = item.image && item.image.length > 0;
                const imageDisplay = hasImage 
                    ? `<img src="${item.image}" class="w-full h-full object-cover" alt="${item.name}">`
                    : `<div class="w-full h-full flex items-center justify-center text-4xl bg-gray-100 text-gray-400">${item.icon}</div>`;

                const div = document.createElement('div');
                div.className = 'bg-white rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group hover:shadow-md transition-all';
                
                div.innerHTML = `
                    <div class="flex p-4 gap-4">
                        <!-- Image Area (Click to Upload) -->
                        <div class="w-24 h-24 rounded-lg overflow-hidden flex-shrink-0 relative cursor-pointer border border-gray-200 group-image" onclick="triggerUpload(${item.id})">
                            ${imageDisplay}
                            <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fa-solid fa-camera text-white"></i>
                            </div>
                            <input type="file" id="file-${item.id}" class="hidden" accept="image/*" onchange="handleImageUpload(event, ${item.id})">
                        </div>

                        <!-- Content Area (Click to Details) -->
                        <div class="flex-grow cursor-pointer" onclick="openScheduleDetails(${item.id})">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-gray-800 text-lg">${item.name}</h3>
                            </div>
                            <div class="grid grid-cols-3 gap-1 text-center text-[10px] mt-2">
                                <div class="bg-gray-50 rounded p-1">
                                    <div class="text-gray-500">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å</div>
                                    <div class="font-semibold text-gray-700">${formatDateShort(start)}</div>
                                </div>
                                <div class="bg-yellow-50 rounded p-1 border border-yellow-100">
                                    <div class="text-yellow-600">‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢</div>
                                    <div class="font-semibold text-yellow-700">${formatDateShort(fertilize)}</div>
                                </div>
                                <div class="bg-orange-50 rounded p-1 border border-orange-100">
                                    <div class="text-orange-600">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</div>
                                    <div class="font-semibold text-orange-700">${formatDateShort(harvest)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Beautiful Delete Button (Top Right) -->
                    <button onclick="deleteSchedule(event, ${item.id})" class="absolute top-2 right-2 w-8 h-8 bg-white hover:bg-red-50 text-gray-400 hover:text-red-500 rounded-full shadow-sm flex items-center justify-center transition-all border border-gray-100 z-10">
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>
                    
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-leaf-500"></div>
                `;
                list.appendChild(div);
            });
        }

        // Function to open details from schedule list
        function openScheduleDetails(id) {
            const item = mySchedules.find(s => s.id === id);
            if (!item) return;
            
            const crop = allCrops.find(c => c.id === item.fruitId);
            if (!crop) return;

            // Open modal with saved date
            openCalcModal(crop, new Date(item.startDate));
        }

        function deleteSchedule(event, id) {
            event.stopPropagation(); // Prevent opening the modal
            if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                mySchedules = mySchedules.filter(item => item.id !== id);
                localStorage.setItem('myPlantingSchedule', JSON.stringify(mySchedules));
                renderScheduleList();
            }
        }

        // --- Helper Functions ---
        function toggleView(view) {
            const calendarView = document.getElementById('calendar-view');
            const scheduleView = document.getElementById('schedule-view');
            const navSchedule = document.getElementById('nav-schedule');
            
            if(view === 'schedule') {
                calendarView.classList.add('hidden');
                scheduleView.classList.remove('hidden');
                if(navSchedule) navSchedule.classList.add('text-leaf-600');
            } else {
                scheduleView.classList.add('hidden');
                calendarView.classList.remove('hidden');
                if(navSchedule) navSchedule.classList.remove('text-leaf-600');
            }
        }

        function formatDate(date) {
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
        }
        
        function formatDateShort(date) {
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        }

        // --- Chat Functions ---
        function toggleChat() {
            const chatWindow = document.getElementById('chatbot-window');
            if (chatWindow.classList.contains('hidden')) {
                chatWindow.classList.remove('hidden');
                // Allow a tiny delay for transition to work if not hidden immediately
                setTimeout(() => {
                    chatWindow.classList.remove('translate-y-full');
                }, 10);
            } else {
                chatWindow.classList.add('translate-y-full');
                setTimeout(() => {
                    chatWindow.classList.add('hidden');
                }, 300);
            }
        }

        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function appendMessage(text, isUser) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `chat-msg ${isUser ? 'chat-user' : 'chat-bot'} animate-pop`;
            div.innerHTML = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = `chat-msg chat-bot`;
            div.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            // 1. Show User Message
            appendMessage(text, true);
            input.value = '';

            // 2. Show Typing
            showTypingIndicator();

            // 3. Call Backend
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'chat', message: text })
                });

                let reply = "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢";
                if (response.ok) {
                    const data = await response.json();
                    reply = data.reply || "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö";
                } else {
                    // Fallback simulation if backend fails (common in demos)
                    await new Promise(r => setTimeout(r, 1000));
                    if (text.includes('‡∏£‡∏≤‡∏Ñ‡∏≤')) reply = "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö";
                    else if (text.includes('‡∏õ‡∏•‡∏π‡∏Å')) reply = "‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏û‡∏∑‡∏ä‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î‡∏°‡∏µ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏ô‡πÉ‡∏à‡∏û‡∏∑‡∏ä‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?";
                    else reply = "‡∏ú‡∏°‡πÄ‡∏õ‡πá‡∏ô AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Å‡∏©‡∏ï‡∏£ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö";
                }

                removeTypingIndicator();
                appendMessage(reply, false);

            } catch (error) {
                removeTypingIndicator();
                appendMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö", false);
                console.error(error);
            }
        }

        // --- Calculator Logic ---
        function openCalculator() {
            document.getElementById('calculator-modal').classList.remove('hidden');
        }
        function closeCalculator() {
            document.getElementById('calculator-modal').classList.add('hidden');
        }
        function calcAppend(val) {
            const display = document.getElementById('calc-display');
            if(display.value === '0' && val !== '.') display.value = '';
            display.value += val;
        }
        function calcClear() {
            document.getElementById('calc-display').value = '0';
        }
        function calcEqual() {
            const display = document.getElementById('calc-display');
            try {
                display.value = eval(display.value) || '0';
            } catch {
                display.value = 'Error';
                setTimeout(calcClear, 1000);
            }
        }

    </script>
</body>
</html>
